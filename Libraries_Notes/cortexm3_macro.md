# cortexm3_macro.s / cortexm3_macro.h 정리

> 안내  
> `cortexm3_macro.s`는 Cortex-M3 코어의 특수 명령을 어셈블리어로 감싼 저수준 코드로,
> 일반적인 학부 마이크로프로세서 실습 과목의 학습 범위를 넘어서는 내용이라 생각한다.
> 본 문서는 해당 파일의 내부 구현을 세부적으로 분석하기보다는,
> 각 명령이 수행하는 역할과 Cortex-M3 아키텍처 관점에서의 의미를 정리하는 데 목적이 있으며,
> 이 문서를 정리하는 과정에서 ChatGPT의 도움을 받았다.

---

## 개요

`cortexm3_macro`는 Cortex-M3 코어에서 제공하는 **특수 명령 및 특수 레지스터 접근을
C 코드에서 호출 가능하도록 만든 어셈블리 래퍼 집합**이다.

각 함수는 대부분 하나의 CPU 명령을 실행한 뒤 즉시 복귀하며,
주변장치 제어가 아닌 **코어 제어(CPU 상태, 예외, 동기화)** 를 목적으로 한다.

---

## 1) 저전력 및 이벤트 관련 명령 (`__WFI`, `__WFE`, `__SEV`)

### 정의
- `__WFI` : 인터럽트 발생 시까지 코어 실행을 중단한다(Wait For Interrupt).
- `__WFE` : 이벤트 발생 시까지 코어 실행을 중단한다(Wait For Event).
- `__SEV` : 이벤트를 발생시킨다(Send EVent).

### CPU 수준에서의 의미
이 명령들은 코어의 **실행 상태(state)** 를 제어한다.  
명령 실행 후 코어는 명령어를 계속 실행하지 않고,
외부 또는 내부 신호(인터럽트/이벤트)에 의해 다시 활성화된다.

### 비고
- `WFI`와 `WFE`는 대기 조건이 다르며,
- `SEV`는 대기 중인 코어를 깨우기 위한 신호 발생 명령이다.

---

## 2) 명령 및 메모리 동기화 배리어 (`__ISB`, `__DSB`, `__DMB`)

### 정의
- `__ISB` : 이후 명령이 현재 상태를 기준으로 다시 인출되도록 강제한다(Instruction Synchronization Barrier).
- `__DSB` : 이전 데이터 접근이 모두 완료될 때까지 대기한다(Data Synchronization Barrier).
- `__DMB` : 메모리 접근 순서만 보장한다(Data Memory Barrier).

### CPU 수준에서의 의미
Cortex-M3는 성능을 위해 명령 실행 및 메모리 접근을 재정렬할 수 있다.  
배리어 명령은 이러한 재정렬로 인해 **의미가 깨지는 상황을 방지**하기 위해,
명령 실행 순서와 가시성을 강제로 정렬한다.

### 비고
- 배리어는 "**프로그래머가 코드에 부여한 인과관계(원인 → 결과)를 CPU의 성능 최적화로 인해 뒤집히지 않도록 강제하는 장치**"이다.
- 즉, 기능 수행 명령이 아니라 **순서 보장 명령**이다.

---

## 3) 소프트웨어 예외 (`__SVC`)

### 정의
- `__SVC`는 SVC(SuperVisor Call) 예외를 발생시키는 명령이다.

### CPU 수준에서의 의미
SVC 명령은 현재 실행 흐름을 중단하고,
SVC 핸들러로 분기하여 **예외 문맥(handler mode)** 으로 진입하게 만든다.

### 비고
- 하드웨어 인터럽트가 아닌, **소프트웨어가 직접 명령으로 발생시키는 예외**이다.
- 운영체제/커널 호출 메커니즘과 직접적으로 연관된다.

---

## 4) CONTROL 레지스터 접근 (`__MRS_CONTROL`, `__MSR_CONTROL`)

### 정의
- `__MRS_CONTROL` : CONTROL 레지스터 값을 읽는다.
- `__MSR_CONTROL` : CONTROL 레지스터 값을 설정한다.

### CPU 수준에서의 의미
CONTROL 레지스터는
- 스레드 모드에서 사용하는 스택 선택(MSP/PSP)
- 특권/비특권 실행 상태
> 특권 모드 : CPU의 모든 제어 기능에 접근 가능한 상태
> 비특권 모드 : 안전을 위해 일부 동작이 제한된 상태

와 같은 **코어 실행 모드의 기본 성질**을 결정한다.

### 비고
- CONTROL 변경 후 `ISB`가 수행되는 것은,
  변경된 실행 상태가 이후 명령에 확실히 반영되도록 하기 위함이다.

---

## 5) 스택 포인터 접근 (`__MRS_PSP`, `__MSR_PSP`, `__MRS_MSP`, `__MSR_MSP`)

### 정의
- PSP(Process Stack Pointer)와 MSP(Main Stack Pointer)를 읽고 쓴다.

### CPU 수준에서의 의미
Cortex-M3는 실행 문맥에 따라
- 메인 스택 포인터(MSP)
- 프로세스 스택 포인터(PSP)

을 분리해 사용할 수 있으며,
이 함수들은 해당 스택 포인터를 직접 제어한다.

### 비고
- 스택은 여러 정보(함수 호출 시의 지역 변수, 리턴 주소, 레지스터 백업 값 등)를 담는다.
- 해당 스택을 **모든 코드가 하나만 공유**하면, **예외(인터럽트) 처리 중에 실행중이던 코드의 상태를 쉽게 침범**할 수 있다.
- 그래서 Cortex-M3는 다음과 같이 분리했다.
  - 시스템/예외 처리용 스택
  - 일반 코드 실행용 스택
> MSP는 예외와 시스템 처리를 위한 스택 포인터이고,</br>
> PSP는 일반 코드 실행을 위한 스택 포인터이다.

---

## 6) 인터럽트 및 장애 마스크 (`__SETPRIMASK`, `__RESETPRIMASK`,</br>
`__SETFAULTMASK`, `__RESETFAULTMASK`, `__BASEPRICONFIG`, `__GetBASEPRI`)

### 정의
- PRIMASK, FAULTMASK, BASEPRI 레지스터를 설정/해제/조회한다.

### CPU 수준에서의 의미
이 레지스터들은
- 인터럽트가 코어에 전달될 수 있는지
- 어떤 우선순위까지 허용할 것인지

를 **코어 내부에서 직접 제어**한다.

### 비고
- PRIMASK/FAULTMASK는 전역적 차단에 가깝고,
- BASEPRI는 우선순위 기반 제어를 제공한다.

---

## 7) 바이트 순서 변환 (`__REV_HalfWord`, `__REV_Word`)

### 정의
- 16비트(`REV16`) 또는 32비트(`REV`) 단위로 바이트 순서를 반전한다.

### CPU 수준에서의 의미
이 명령은 데이터 값을 변경하는 것이 아니라,
**메모리 내 바이트 배치 순서를 재해석**하는 연산을 수행한다.

### 비고
- 엔디언 차이가 있는 데이터 처리에 사용되는
  순수 연산 유틸리티 명령이다.
